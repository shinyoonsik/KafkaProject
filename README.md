# KafkaProject

- 목적
  - 
  - Kafka Producer & Consumer 성능 테스트

- Test1: Producer 테스트
  - 
  - 상황
    - Broker: 3, Topic: burger-topic, Partition: 3, ISR: 2, Replication-factor: 3
  - Q1: default setting하에 Producer가 메시지 발행시, batch queue를 사용하는지 확인하기
    - [No key]메시지 발행시 0번, 1번, 2번 파티션에 batch형태로 메시지 전송 확인  
    - [With key]메시지 발행시 0번, 1번, 2번 파티션에 batch형태로 메시지 전송이 되지만 key가 없는 형태보다는 batch활용률이 낮음.
        - 파티션으로 보내는 배치크키가 상대적으로 작음.
          - why? 프로듀서의 배치크기는 같으나 key가 있는 경우 파티션이 정해져있으며 배치 큐가 채워지지 않아도 메시지를 발행해야 하는 시간이 동일하기 때문이다. 즉, 배치큐가 채워지지 않고 정해진 발행되는 케이스가 많음
  - Q2: async와 sync 메시지 전송 비교 (TODO: 그래프와 표로 표현하기) with No key
    - 상황: 각 횟수마다 10번 반복에 대한 평균
    - Async(단위는 ms)
      - 100회 : 101
      - 1000회: 263
      - 10000회: 1024
      - 100000회: 7478
    - Sync(단위는 ms)
      - 100회 : 232
      - 1000회: 1161
      - 10000회: 12267
      - 100000회: 150518
    - 생각해볼점!
      - 처음 전송시의 값이 굉장히 많이 튀는 현상 발생. 
        - 이유
          - 프로듀서가 브로커와 처음 연결을 맺고 메타데이터를 가져오는 과정에서 추가적인 시간이 소요된 것이라 추정 
            - 메타데이터 -> 예: 어떤 토픽에 어떤 파티션이 있는지, 각 파티션의 리더가 어디에 위치하는지 등
          - TCP 연결 설정: 프로듀서가 처음 브로커와 연결을 맺을 때 TCP 연결 설정에 시간이 소요될 수 있음
          - (Http통신이므로 SSL/TLS핸드쉐이크 과정은 생략되어 원인이 아닌거 같음)
          - JVM 웜업(Warm-up)시간이 필요
      - sync와 async의 속도 차이 원인
        - 요청에 대한 응답을 기다리느냐 기다리지 않느냐의 차이도 있지만 sync의 경우 produce의 batch를 활용하기 어렵다. 다시 말해, sync의 경우 batch queue를 채워서 전송하지 못한다 
  - Q3: Producer의 acks설정이 0이면 sync이든 asycn이든 offset을 받지못한다
    - acks = 1, all이어야 레코드가 저장된 offset을 받을 수 있다. offset은 리더 파티션에 저장되고 나서야 알수 있는 값이다!
- Test2: Consumer Rebalancing 테스트
  -
  - Q1: 런타임시에 동일한 컨슈머 그룹의 컨슈머 인스턴스를 1개 ~ 3개(토픽수 만큼)증가시키며 테스트
    - 브로커가 Rebalancing작업을 수행할 때마다 추가된 컨슈머 인스턴스에 특정 파티션이 할당됨


- 구조
  - 
  - multi-module
- 카프카 버전
  - 
  - 7.6.0(Confluent Kafka)
- TODO
  - slf4j 1.7.36버전은 producer의 설정정보를 출력하고 최신버전은 출력하지못함...추가적인 조치가 필요! or 어떤점이 달라졌는지 확인해보기